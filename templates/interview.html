<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview in Progress</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Interview in Progress</h1>
            <div id="interviewInfo" class="interview-info"></div>
        </header>

        <main class="interview-container">
            <div id="chatContainer" class="chat-container">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="input-section">
                <div class="voice-controls">
                    <button id="voiceBtn" class="btn btn-voice" title="Click to speak">
                        ðŸŽ¤ Voice Answer
                    </button>
                    <span id="voiceStatus" class="voice-status"></span>
                </div>

                <div class="text-input-group">
                    <textarea 
                        id="answerInput" 
                        placeholder="Type your answer here..." 
                        rows="3"
                    ></textarea>
                    <button id="sendBtn" class="btn btn-primary">Send</button>
                </div>

                <div class="action-buttons">
                    <button id="endBtn" class="btn btn-secondary">End Interview & Get Feedback</button>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/script.js"></script>
    <script>
        const sessionId = "{{ session_id }}";
        
        // Initialize interview
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`/api/session/${sessionId}`);
                const session = await response.json();
                
                document.getElementById('interviewInfo').innerHTML = `
                    <span><strong>Role:</strong> ${session.role}</span>
                    <span><strong>Level:</strong> ${session.experience_level}</span>
                    <span><strong>Question:</strong> <span id="questionCounter">1</span></span>
                `;
                
                // Display first question
                addMessage('interviewer', session.current_question);
                
                // Initialize voice if available
                initializeVoice();
                
            } catch (error) {
                console.error('Error loading session:', error);
                alert('Error loading interview session');
            }
        });

        // Send answer
        document.getElementById('sendBtn').addEventListener('click', submitAnswer);
        document.getElementById('answerInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitAnswer();
            }
        });

        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();
            
            if (!answer) {
                alert('Please provide an answer');
                return;
            }

            // Disable inputs while processing
            answerInput.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            // Display user's answer
            addMessage('user', answer);
            answerInput.value = '';

            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: answer
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Update question counter
                    document.getElementById('questionCounter').textContent = data.question_number;
                    
                    // Display next question
                    addMessage('interviewer', data.question);
                } else {
                    alert('Error: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error submitting answer: ' + error.message);
            } finally {
                answerInput.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                answerInput.focus();
            }
        }

        // End interview
        document.getElementById('endBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to end the interview and get feedback?')) {
                return;
            }

            document.getElementById('endBtn').disabled = true;
            document.getElementById('endBtn').textContent = 'Generating feedback...';

            try {
                const response = await fetch('/api/end-interview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    window.location.href = data.redirect_url;
                } else {
                    alert('Error: ' + (data.detail || 'Unknown error'));
                    document.getElementById('endBtn').disabled = false;
                    document.getElementById('endBtn').textContent = 'End Interview & Get Feedback';
                }
            } catch (error) {
                alert('Error ending interview: ' + error.message);
                document.getElementById('endBtn').disabled = false;
                document.getElementById('endBtn').textContent = 'End Interview & Get Feedback';
            }
        });

        function addMessage(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const label = sender === 'interviewer' ? 'ðŸ‘” Interviewer' : 'ðŸ‘¤ You';
            messageDiv.innerHTML = `
                <div class="message-label">${label}</div>
                <div class="message-content">${text}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Read aloud if interviewer and TTS available
            if (sender === 'interviewer' && window.speechSynthesis) {
                speakText(text);
            }
        }
    </script>
</body>
</html>